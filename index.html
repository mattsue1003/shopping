<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚é½¡å¤§è…¦é«”æ“ - è¶…å¸‚è³¼ç‰©è¨ˆç®—ç”¢ç”Ÿå™¨</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- åŸºç¤è¨­å®š (æ©˜è‰²è¶…å¸‚è³¼ç‰©ä¸»é¡Œ) --- */
        :root {
            --primary-color: #ea580c;  /* æ©˜è‰²ç³» */
            --primary-hover: #c2410c;
            --dark-color: #431407;
            --bg-color: #fff7ed;
            --border-color: #fdba74;
            --accent-color: #f97316;
        }

        body { 
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; 
            background: var(--bg-color); 
            margin: 0; 
            padding: 0;
            color: #334155;
        }
        
        .top-banner { background: var(--primary-color); height: 5px; width: 100%; }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .controls {
            background: white; 
            padding: 20px; 
            border-radius: 0 0 16px 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            max-width: 900px; 
            margin: 0 auto 20px auto; 
        }
        
        .controls h2 { margin: 0 0 12px 0; color: var(--dark-color); font-size: 1.4rem; }

        .designer-info {
            background: #fff7ed; padding: 10px 14px; border-radius: 8px; font-size: 0.95rem;
            color: #9a3412; margin-bottom: 15px; border-left: 4px solid var(--primary-color);
            line-height: 1.6;
        }
        .designer-info a { color: #c2410c; text-decoration: none; font-weight: bold; border-bottom: 1px solid #c2410c; }
        .designer-info a:hover { color: #ea580c; border-bottom-color: #ea580c; }

        .control-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 4px; color: #475569; font-size: 0.85rem; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; }

        .btn-group { grid-column: 1 / -1; display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        button { flex: 1; min-width: 130px; padding: 12px; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer; color: white; transition: all 0.2s; }
        button:active { transform: scale(0.96); }
        .gen-btn { background: var(--primary-color); }
        .print-btn { background: #475569; }
        .pdf-btn { background: #059669; }

        /* --- éŸ¿æ‡‰å¼ A4 é è¦½å€ --- */
        .preview-area { width: 100%; overflow-x: hidden; display: flex; flex-direction: column; align-items: center; padding-bottom: 40px; }
        
        .sheet-scaler { transform-origin: top center; margin-bottom: 15px; }

        /* A4 ç´™å¼µæœ¬é«” */
        .sheet {
            background: white; 
            width: 210mm; 
            height: 297mm; 
            padding: 8mm 15mm; /* å¾®èª¿ä¸Šä¸‹é‚Šè·ç¢ºä¿å…§å®¹ä¸æº¢å‡º */
            box-sizing: border-box; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        /* --- ç´™å¼µå…§éƒ¨ä½ˆå±€ --- */
        .sheet-header { border-bottom: 2px solid #431407; padding-bottom: 4px; margin-bottom: 6px; }
        .sheet-title { text-align: center; font-size: 24pt; font-weight: 900; margin-bottom: 4px; color: #431407; line-height: 1.2; letter-spacing: 2px; }
        .sheet-info { display: flex; justify-content: space-between; font-size: 11pt; font-weight: bold; color: #334155; }

        .instruction-text {
            text-align: center; color: #9a3412; font-weight: 800; font-size: 11pt;
            margin-bottom: 4px; background: #ffedd5; padding: 6px; border-radius: 6px; border: 1px solid #fed7aa;
        }

        /* å€å¡Šæ¨™é¡Œ */
        .section-title {
            font-size: 13pt; font-weight: bold; color: #9a3412; 
            margin: 6px 0 4px 0; border-left: 5px solid var(--accent-color); padding-left: 10px;
        }

        /* --- ä¸ŠåŠéƒ¨ï¼šåƒè€ƒæ•¸æ“šè¡¨æ ¼ (4x4 ç¶²æ ¼) --- */
        .ref-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 4px;
        }
        .ref-item {
            background: #fafaf9; border: 2px solid #e5e5e5; border-radius: 8px; 
            padding: 6px 4px; text-align: center; display: flex; flex-direction: column; justify-content: center;
            align-items: center; gap: 4px; position: relative;
        }
        /* æ¨¡æ“¬è¶…å¸‚ç‰¹åƒ¹æ¨™ç±¤ */
        .ref-item::before {
            content: "ç‰¹åƒ¹"; position: absolute; top: -6px; left: -6px; background: #dc2626; color: white;
            font-size: 7pt; padding: 2px 4px; border-radius: 4px; font-weight: bold;
        }
        .ref-name { font-size: 14pt; font-weight: bold; color: #1c1917; line-height: 1.2;}
        .ref-price-row { display: flex; align-items: center; justify-content: center; gap: 4px; width: 100%; margin-top: 2px;}
        .ref-unit { font-size: 11pt; color: #78716c; font-weight: bold; }
        .ref-value { font-size: 13pt; font-weight: 900; color: #ea580c; background: #ffedd5; border-radius: 6px; padding: 2px 8px;}

        /* --- ä¸‹åŠéƒ¨ï¼šæ¸¬é©—ä½œç­”å€ (2x5 ç¶²æ ¼) --- */
        .quiz-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px 24px; flex-grow: 1; align-content: start;
        }
        .quiz-item {
            display: flex; flex-direction: column; justify-content: center;
            border-bottom: 2px dashed #cbd5e1; padding: 12px 4px 10px 4px; /* å¾®èª¿ä¸Šä¸‹é–“è·ï¼Œé¿å…é å°¾è¢«è£åˆ‡ */
        }
        .quiz-question { display: flex; align-items: baseline; margin-bottom: 6px;} /* å¢åŠ é¡Œç›®èˆ‡ç­”æ¡ˆç·šçš„è·é›¢ */
        .quiz-no { font-weight: bold; color: #ea580c; width: 28px; font-size: 13pt; }
        .quiz-text { font-weight: bold; color: #1e293b; font-size: 13pt; letter-spacing: 0.5px;}
        .quiz-ans-area { display: flex; justify-content: flex-end; align-items: center; width: 100%; font-size: 13pt; font-weight: bold; color: #475569;}
        .quiz-ans-input { display: inline-block; width: 120px; border-bottom: 2px solid #475569; margin: 0 6px; text-align: center; color: #dc2626; height: 24px; } /* å¢åŠ ä½œç­”å€å¯¬åº¦åˆ° 120pxï¼Œä¸¦åŠ ç²—åº•ç·š */
        
        .sheet-footer { 
            display: flex; justify-content: space-between; font-size: 10pt; font-weight: bold; color: #64748b; 
            margin-top: auto; padding-top: 6px; padding-bottom: 2px; border-top: 1px solid #e2e8f0;
        }

        #hidden-capture-container { position: fixed; top: 0; left: -5000px; width: 210mm; background: white; z-index: -9999; }

        @media print {
            @page { margin: 0; size: A4 portrait; }
            body { padding: 0; background: white; }
            .controls, .top-banner { display: none; }
            .preview-area { padding: 0; }
            .sheet-scaler { transform: none !important; margin: 0; height: auto !important; }
            .sheet { box-shadow: none; margin: 0; page-break-after: always; }
        }

        @media (max-width: 600px) {
            body { padding: 0; }
            .controls { padding: 15px; border-radius: 0; }
            .btn-group button { min-width: 100%; }
        }
    </style>
</head>
<body>

<div class="top-banner"></div>

<div class="controls no-print">
    <h2>ğŸ›’ æ¨‚é½¡å¤§è…¦é«”æ“ - è¶…å¸‚è³¼ç‰©è¨ˆç®—ç”¢ç”Ÿå™¨</h2>
    <div class="designer-info">
        ç›®çš„ï¼šè¨“ç·´è¦–è¦ºæœå°‹ã€æ—¥å¸¸ç”Ÿæ´»é‡‘éŒ¢è¨ˆç®—èˆ‡åŸ·è¡ŒåŠŸèƒ½ã€‚<br>
        ç‰ˆé¢é…ç½®ï¼š<b>ä¸ŠåŠéƒ¨ç‚ºè¶…å¸‚å•†å“åƒ¹æ ¼è¡¨ï¼Œä¸‹åŠéƒ¨ç‚ºè³¼ç‰©æ¸…å–®ç®—æ•¸é¡Œã€‚</b><br>
        ç©æ³•ï¼šè«‹é•·è¼©æ ¹æ“šä¸Šæ–¹ç‰¹åƒ¹è¡¨ï¼Œå°‹æ‰¾æ¸…å–®ä¸­çš„å•†å“å–®åƒ¹ï¼Œä¸¦è¨ˆç®—å‡ºæ¯æ¬¡è³¼ç‰©çš„ç¸½èŠ±è²»ã€‚<br>
        è¨­è¨ˆç†å¿µï¼šæ¨¡æ“¬çœŸå¯¦ç”Ÿæ´»æƒ…å¢ƒï¼Œä¸åƒ…å‹•è…¦ä¹Ÿå…·å‚™é«˜åº¦å¯¦ç”¨æ€§ã€‚<br>
        è¨­è¨ˆè€…ï¼š<a href="https://www.facebook.com/profile.php?id=100063748491881" target="_blank">é¾å­Ÿä¿® è·èƒ½æ²»ç™‚å¸« (é‚€è«‹å¤§å®¶é»å…¥è¿½è¹¤)</a>
    </div>

    <div class="control-grid">
        <div class="control-group">
            <label>ğŸ“ è¨“ç·´å·æ¨™é¡Œ</label>
            <input type="text" id="titleInput" value="ç²¾æ‰“ç´°ç®—è³¼ç‰©æŒ‘æˆ°">
        </div>

        <div class="control-group">
            <label>ğŸ“„ ç”¢ç”Ÿé æ•¸</label>
            <input type="number" id="pageCount" value="1" min="1" max="10">
        </div>

        <div class="control-group">
            <label>ğŸ‘€ ç­”æ¡ˆé¡¯ç¤º</label>
            <select id="answerMode">
                <option value="end" selected>æ–¼æœ«é é™„ä¸Šè§£ç­”</option>
                <option value="none">ä¸éœ€è¦è§£ç­”é </option>
            </select>
        </div>
    </div>

    <div class="btn-group">
        <button class="gen-btn" onclick="generateSheets()">âœ¨ é‡æ–°ç”¢ç”Ÿæ¸¬é©—å·</button>
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ ç›´æ¥åˆ—å°</button>
        <button class="pdf-btn" id="pdfBtn" onclick="downloadPDF()">ğŸ“± ä¸‹è¼‰ PDF</button>
    </div>
</div>

<div class="preview-area" id="outputArea"></div>

<div id="hidden-capture-container"></div>

<script>
    // å»ºç«‹è¶…å¸‚å•†å“è³‡æ–™åº« 
    const GROCERY_DB = [
        { name: 'é®®å¥¶', unit: 'ç“¶', price: 90 },
        { name: 'é›è›‹', unit: 'ç›’', price: 65 },
        { name: 'é«˜éº—èœ', unit: 'é¡†', price: 45 },
        { name: 'ç™½ç±³', unit: 'åŒ…', price: 150 },
        { name: 'æ²™æ‹‰æ²¹', unit: 'ç“¶', price: 120 },
        { name: 'é†¬æ²¹', unit: 'ç“¶', price: 55 },
        { name: 'è¡›ç”Ÿç´™', unit: 'ä¸²', price: 110 },
        { name: 'é’è”¥', unit: 'æŠŠ', price: 20 },
        { name: 'è±¬è‚‰ç‰‡', unit: 'ç›’', price: 85 },
        { name: 'é®­é­š', unit: 'ç‰‡', price: 130 },
        { name: 'è˜‹æœ', unit: 'é¡†', price: 25 },
        { name: 'é¦™è•‰', unit: 'ä¸²', price: 40 },
        { name: 'åå¸', unit: 'æ¢', price: 45 },
        { name: 'è±†è…', unit: 'ç›’', price: 15 },
        { name: 'ç‰ç±³', unit: 'æ ¹', price: 18 },
        { name: 'æ´‹è”¥', unit: 'è¢‹', price: 50 },
        { name: 'æ´—è¡£ç²¾', unit: 'ç“¶', price: 140 },
        { name: 'æ´—é«®ä¹³', unit: 'ç“¶', price: 125 },
        { name: 'ç‰™è†', unit: 'æ¢', price: 65 },
        { name: 'é¤…ä¹¾', unit: 'åŒ…', price: 35 },
        { name: 'ç‡•éº¥ç‰‡', unit: 'ç½', price: 160 },
        { name: 'å¥‡ç•°æœ', unit: 'é¡†', price: 20 },
        { name: 'ç½é ­', unit: 'ç½', price: 30 },
        { name: 'éºµæ¢', unit: 'åŒ…', price: 40 }
    ];

    function shuffleArray(array) {
        let copy = [...array];
        for (let i = copy.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
    }

    function generatePageData() {
        // éš¨æ©ŸæŠ½é¸ 16 å€‹å•†å“æ”¾åœ¨ä¸ŠåŠéƒ¨åƒè€ƒè¡¨ (4x4)
        let refItems = shuffleArray(GROCERY_DB).slice(0, 16);
        
        let quizItems = [];
        // ç”¢ç”Ÿ 10 é¡Œè³¼ç‰©æ¸…å–®è¨ˆç®— (æ¯é¡Œ10åˆ†ï¼Œæ’ç‰ˆé©åˆ 2x5 ç¶²æ ¼)
        for (let i = 0; i < 10; i++) {
            // æ±ºå®šé¡Œç›®é¡å‹ï¼š 
            // 0: è²· A (1å€‹) + è²· B (1å€‹)
            // 1: è²· A (2å€‹) + è²· B (1å€‹)
            // 2: è²· A (1å€‹) + B (1å€‹) + C (1å€‹)
            let type = Math.floor(Math.random() * 3);
            let qText = "";
            let ans = 0;
            
            // å¾é€™ 16 å€‹ä¸Šæ¶å•†å“è£¡æŠ½æ¨£ä¾†å‡ºé¡Œ
            let items = shuffleArray(refItems); 
            
            if (type === 0) { 
                let item1 = items[0];
                let item2 = items[1];
                qText = `è²· 1${item1.unit} ${item1.name} ï¼‹ 1${item2.unit} ${item2.name}`;
                ans = item1.price + item2.price;
            } else if (type === 1) { 
                let item1 = items[0];
                let item2 = items[1];
                qText = `è²· 2${item1.unit} ${item1.name} ï¼‹ 1${item2.unit} ${item2.name}`;
                ans = (item1.price * 2) + item2.price;
            } else { 
                let item1 = items[0];
                let item2 = items[1];
                let item3 = items[2];
                qText = `è²· 1${item1.unit}${item1.name}ã€1${item2.unit}${item2.name} åŠ  1${item3.unit}${item3.name}`;
                ans = item1.price + item2.price + item3.price;
            }
            
            quizItems.push({ question: qText, answer: ans });
        }
        
        return { refItems, quizItems };
    }

    function updateScale() {
        const previewArea = document.getElementById('outputArea');
        const scalers = document.querySelectorAll('.sheet-scaler');
        if (scalers.length === 0) return;

        const containerWidth = previewArea.clientWidth - 30;
        const sheetWidthPx = 210 * 3.7795; 
        
        let scale = containerWidth / sheetWidthPx;
        if (scale > 1) scale = 1;

        scalers.forEach(el => {
            el.style.transform = `scale(${scale})`;
            el.style.height = (297 * 3.7795 * scale) + "px";
        });
    }

    window.addEventListener('resize', updateScale);

    function generateSheets() {
        const title = document.getElementById('titleInput').value;
        const pages = parseInt(document.getElementById('pageCount').value);
        const answerMode = document.getElementById('answerMode').value;
        const container = document.getElementById('outputArea');

        container.innerHTML = '';
        let sheetsData = [];

        for (let i = 1; i <= pages; i++) {
            const data = generatePageData();
            sheetsData.push(data);

            const scaler = document.createElement('div');
            scaler.className = 'sheet-scaler';
            
            const sheetDiv = document.createElement('div');
            sheetDiv.className = 'sheet';
            
            sheetDiv.innerHTML = `
                <div class="sheet-header">
                    <div class="sheet-title">${title}</div>
                    <div class="sheet-info">
                        <span>å§“åï¼š__________</span>
                        <span>æ—¥æœŸï¼š___æœˆ___æ—¥</span>
                        <span>å¾—åˆ†ï¼š____ / 100</span>
                    </div>
                </div>
                
                <div class="instruction-text">ğŸ’¡ è³¼ç‰©å¤§æŒ‘æˆ°ï¼šè«‹æŸ¥çœ‹ä¸Šæ–¹ã€Œè¶…å¸‚ç‰¹åƒ¹è¡¨ã€ç®—å‡ºç¸½èŠ±è²»ï¼(å…±10é¡Œï¼Œæ¯é¡Œ10åˆ†)</div>
                
                <div class="section-title">ğŸ›’ è¶…å¸‚ç‰¹åƒ¹è¡¨</div>
                <div class="ref-grid">
                    ${data.refItems.map(item => `
                        <div class="ref-item">
                            <div class="ref-name">${item.name}</div>
                            <div class="ref-price-row">
                                <span class="ref-unit">(æ¯${item.unit})</span>
                                <span class="ref-value">${item.price}å…ƒ</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="section-title">ğŸ“ è³¼ç‰©æ¸…å–®ç®—ç®—çœ‹</div>
                <div class="quiz-grid">
                    ${data.quizItems.map((q, idx) => `
                        <div class="quiz-item">
                            <div class="quiz-question">
                                <span class="quiz-no">${idx + 1}.</span>
                                <span class="quiz-text">${q.question}</span>
                            </div>
                            <div class="quiz-ans-area">
                                å…± <span class="quiz-ans-input"></span> å…ƒ
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="sheet-footer">
                    <span>æ¸¬é©—å· - ç¬¬ ${i} é </span>
                    <span>è¨­è¨ˆè€…ï¼šé¾å­Ÿä¿® è·èƒ½æ²»ç™‚å¸«</span>
                </div>
            `;
            scaler.appendChild(sheetDiv);
            container.appendChild(scaler);
        }

        // ç”¢ç”Ÿè§£ç­”é 
        if (answerMode === 'end') {
            sheetsData.forEach((data, i) => {
                const pageNum = i + 1;
                const scaler = document.createElement('div');
                scaler.className = 'sheet-scaler';
                
                const ansSheetDiv = document.createElement('div');
                ansSheetDiv.className = 'sheet';
                
                ansSheetDiv.innerHTML = `
                    <div class="sheet-header">
                        <div class="sheet-title">${title} - è§£ç­”</div>
                    </div>
                    
                    <div class="section-title">ğŸ›’ è¶…å¸‚ç‰¹åƒ¹è¡¨</div>
                    <div class="ref-grid">
                        ${data.refItems.map(item => `
                            <div class="ref-item">
                                <div class="ref-name">${item.name}</div>
                                <div class="ref-price-row">
                                    <span class="ref-unit">(æ¯${item.unit})</span>
                                    <span class="ref-value">${item.price}å…ƒ</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="section-title">ğŸ“ è³¼ç‰©æ¸…å–®è§£ç­”å€</div>
                    <div class="quiz-grid">
                        ${data.quizItems.map((q, idx) => `
                            <div class="quiz-item">
                                <div class="quiz-question">
                                    <span class="quiz-no">${idx + 1}.</span>
                                    <span class="quiz-text">${q.question}</span>
                                </div>
                                <div class="quiz-ans-area">
                                    å…± <span class="quiz-ans-input">${q.answer}</span> å…ƒ
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="sheet-footer">
                        <span>è§£ç­”å· - å°æ‡‰ç¬¬ ${pageNum} é é¡Œç›®</span>
                        <span>è¨­è¨ˆè€…ï¼šé¾å­Ÿä¿® è·èƒ½æ²»ç™‚å¸«</span>
                    </div>
                `;
                scaler.appendChild(ansSheetDiv);
                container.appendChild(scaler);
            });
        }
        
        setTimeout(updateScale, 100);
    }

    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const btn = document.getElementById('pdfBtn');
        const originalText = btn.innerText;
        const sheets = document.querySelectorAll('.sheet');
        const hiddenContainer = document.getElementById('hidden-capture-container');
        
        if (sheets.length === 0) return alert("è«‹å…ˆç”¢ç”Ÿæ¸¬é©—å·");

        btn.disabled = true;
        btn.innerText = "â³ è™•ç†ä¸­...";

        try {
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            for (let i = 0; i < sheets.length; i++) {
                btn.innerText = `â³ æ­£åœ¨ç”Ÿæˆç¬¬ ${i+1}/${sheets.length} é ...`;
                
                const clone = sheets[i].cloneNode(true);
                clone.style.transform = "none";
                clone.style.margin = "0";
                hiddenContainer.appendChild(clone);

                const canvas = await html2canvas(clone, { 
                    scale: 2.5,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: 210 * 3.7795,
                    height: 297 * 3.7795,
                    windowWidth: 210 * 3.7795
                });
                
                hiddenContainer.removeChild(clone);

                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                if (i > 0) pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            }
            pdf.save('è¶…å¸‚è³¼ç‰©è¨ˆç®—æ¸¬é©—å·.pdf');
        } catch (err) {
            console.error(err);
            alert("PDF ä¸‹è¼‰å¤±æ•—ã€‚è‹¥ä½¿ç”¨æ‰‹æ©Ÿï¼Œå»ºè­°æ”¹é»æ“Šã€Œåˆ—å°ã€å¾Œé¸æ“‡ã€Œå¦å­˜ç‚º PDFã€ã€‚");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    window.onload = generateSheets;
</script>

</body>
</html>
